<!DOCTYPE html>
<html lang="ru" class="light">
<head>
  <meta charset="UTF-8">
  <title>жиру.нет</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg-light: #f9fafb;
      --bg-dark: #111827;
      --text-light: #1f2937;
      --text-dark: #f3f4f6;
      --card-light: #ffffff;
      --card-dark: #1f2937;
      --primary: #3b82f6;
      --muted-light: #6b7280;
      --muted-dark: #9ca3af;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-light);
      padding: 2rem;
      transition: background 0.3s, color 0.3s;
    }

    .dark body {
      background-color: var(--bg-dark);
      color: var(--text-dark);
    }

    .container { max-width: 800px; margin: auto; }
    .card {
      background: var(--card-light);
      padding: 1.5rem;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .dark .card { background: var(--card-dark); }

    input, button, select {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    .theme-toggle {
      text-align: right;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="theme-toggle">
    <button onclick="toggleTheme()">Переключить тему</button>
  </div>

  <div id="auth" class="card">
    <h2>Вход или регистрация</h2>
    <input type="text" id="username" placeholder="Логин">
    <input type="password" id="password" placeholder="Пароль">
    <button onclick="handleAuth()">Войти / Зарегистрироваться</button>
  </div>

  <div id="quiz" class="card" style="display:none;">
    <h2 id="quizQuestion"></h2>
    <div id="quizOptions"></div>
  </div>

  <div id="main" style="display:none">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Добро пожаловать, <span id="userDisplay"></span></h2>
        <button onclick="logout()" style="width:auto">Выйти</button>
      </div>
      <p>Цель: <strong id="goalDisplay"></strong></p>
      <p><input type="date" id="datePicker"></p>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <p>Калорий: <span id="caloriesTotal">0</span></p>
    </div>

    <div class="card">
      <h3>Добавить продукт</h3>
      <select id="mealType">
        <option>Завтрак</option>
        <option>Обед</option>
        <option>Ужин</option>
        <option>Перекус</option>
      </select>
      <input type="text" id="productName" placeholder="Название">
      <input type="number" id="productGrams" placeholder="Грамм">
      <button onclick="addProduct()">Добавить</button>
    </div>

    <div class="card">
      <h3>Продукты на <span id="selectedDateLabel"></span></h3>
      <div id="mealsList"></div>
    </div>
  </div>
</div>

<script>
const goals = { 'Похудение': 1200, 'Поддержание': 2000, 'Набор массы': 2800 };
const questions = [
  { question: 'Какова ваша цель?', options: ['Похудение', 'Поддержание', 'Набор массы'] }
];
let currentUser = null;
let userGoal = null;
let currentQuestion = 0;
let quizPassed = false;
let mealsByDate = {}; // { date: { mealType: [ {name, grams, calories} ] } }

function toggleTheme() {
  const root = document.documentElement;
  if (root.classList.contains('dark')) {
    root.classList.remove('dark');
    root.classList.add('light');
    localStorage.setItem('theme', 'light');
  } else {
    root.classList.remove('light');
    root.classList.add('dark');
    localStorage.setItem('theme', 'dark');
  }
}

(function applySavedTheme() {
  const theme = localStorage.getItem('theme') || 'light';
  document.documentElement.className = theme;
})();

function handleAuth() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  if (!u || !p) return alert("Введите логин и пароль");
  currentUser = u;
  userGoal = localStorage.getItem(u + '_goal');
  quizPassed = localStorage.getItem(u + '_quiz') === 'true';
  const meals = localStorage.getItem(u + '_meals');
  mealsByDate = meals ? JSON.parse(meals) : {};
  if (!quizPassed || !userGoal) showQuiz(); else showMain();
}

function showQuiz() {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('quiz').style.display = 'block';
  const q = questions[currentQuestion];
  document.getElementById('quizQuestion').innerText = q.question;
  const container = document.getElementById('quizOptions');
  container.innerHTML = '';
  q.options.forEach(opt => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => {
      userGoal = opt;
      localStorage.setItem(currentUser + '_goal', userGoal);
      localStorage.setItem(currentUser + '_quiz', 'true');
      showMain();
    };
    container.appendChild(btn);
  });
}

function showMain() {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  document.getElementById('userDisplay').innerText = currentUser;
  document.getElementById('goalDisplay').innerText = userGoal;
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('datePicker').value = today;
  document.getElementById('selectedDateLabel').innerText = today;
  updateMeals();
}

function logout() {
  location.reload();
}

document.getElementById('datePicker').addEventListener('change', () => {
  const d = document.getElementById('datePicker').value;
  document.getElementById('selectedDateLabel').innerText = d;
  updateMeals();
});

function addProduct() {
  const date = document.getElementById('datePicker').value;
  const meal = document.getElementById('mealType').value;
  const name = document.getElementById('productName').value;
  const grams = parseInt(document.getElementById('productGrams').value);
  const cal = Math.floor(Math.random() * 300);
  if (!mealsByDate[date]) mealsByDate[date] = {};
  if (!mealsByDate[date][meal]) mealsByDate[date][meal] = [];
  mealsByDate[date][meal].push({ name, grams, calories: cal });
  localStorage.setItem(currentUser + '_meals', JSON.stringify(mealsByDate));
  updateMeals();
}

function updateMeals() {
  const date = document.getElementById('datePicker').value;
  const container = document.getElementById('mealsList');
  container.innerHTML = '';
  let total = 0;
  const meals = mealsByDate[date] || {};
  for (const meal in meals) {
    const section = document.createElement('div');
    section.innerHTML = `<strong>${meal}</strong>`;
    meals[meal].forEach(p => {
      const line = document.createElement('div');
      line.textContent = `${p.name} — ${p.grams} г, ${p.calories} ккал`;
      section.appendChild(line);
      total += p.calories;
    });
    container.appendChild(section);
  }
  document.getElementById('caloriesTotal').innerText = total;
  const percent = Math.min(100, total / goals[userGoal] * 100);
  document.getElementById('progressFill').style.width = percent + '%';
}
</script>
</body>
</html>
